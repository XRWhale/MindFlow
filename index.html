<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow - 오늘</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f7f7f8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#121a31" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    </style>
</head>
<body class="bg-[#f7f7f8] text-[#121a31] min-h-screen flex flex-col">

    <!-- Header -->
    <header class="flex items-center justify-between px-6 pt-8 pb-4">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-full bg-[#121a31] flex items-center justify-center text-white">
                <span class="material-symbols-outlined text-2xl">spa</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight">Mindflow</h1>
        </div>
        <button class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center border border-black/5 hidden" id="installBtn">
            <span class="material-symbols-outlined">download</span>
        </button>
    </header>

    <main class="flex-1 px-6 pb-32">
        <!-- Hero Title -->
        <div class="mt-4 mb-8">
            <h2 class="text-[28px] font-bold leading-tight">Mindflow가 고른 오늘의 3개</h2>
            <p class="text-[#121a31]/60 mt-2 text-base">오늘 꼭 확인해 볼 콘텐츠예요</p>
        </div>

        <!-- Cards -->
        <div id="todayList" class="space-y-6"></div>
    </main>

    <!-- Floating CTA -->
    <div class="fixed bottom-24 left-0 right-0 px-6 flex justify-center pointer-events-none z-40" id="ctaArea" style="display:none;">
        <button id="completeBtn" class="pointer-events-auto bg-[#121a31] text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 hover:scale-[1.02] active:scale-95 transition-all w-full max-w-md justify-center">
            <span class="text-base font-semibold" id="ctaText">오늘 3개 완료하기</span>
            <span class="material-symbols-outlined text-xl" id="ctaIcon">check_circle</span>
        </button>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-sm bg-[#121a31]/95 backdrop-blur-xl rounded-full shadow-2xl z-50 px-2 py-2">
        <div class="flex items-center justify-around">
            <a href="/" class="flex flex-col items-center justify-center p-3 rounded-full text-white bg-white/10">
                <span class="material-symbols-outlined">home</span>
            </a>
            <a href="/home" class="flex flex-col items-center justify-center p-3 rounded-full text-white/40 hover:text-white/70 transition-colors">
                <span class="material-symbols-outlined">grid_view</span>
            </a>
            <a href="/report" class="flex flex-col items-center justify-center p-3 rounded-full text-white/40 hover:text-white/70 transition-colors">
                <span class="material-symbols-outlined">analytics</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { addItem, getTodayPicks, incrementViewCount, escapeHtml, migrateItems } from '/js/storage.js';

        migrateItems();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }

        // Handle incoming share
        const params = new URLSearchParams(location.search);
        const title = params.get('title') || '';
        const text = params.get('text') || '';
        const rawUrl = params.get('url') || '';

        // Extract URL from text field (Instagram etc. put URL in text)
        function extractUrl(str) {
            const match = str.match(/https?:\/\/[^\s]+/);
            return match ? match[0] : '';
        }
        const url = rawUrl || extractUrl(text);

        if (title || url) {
            addItem({ title, url });
        }

        const INTENT_STYLES = {
            '영감': { bg: 'background:#FFF3E0', color: 'color:#E65100', icon: 'auto_awesome', deco: 'palette' },
            '배움': { bg: 'background:#E3F2FD', color: 'color:#1565C0', icon: 'school', deco: 'menu_book' },
            '실행': { bg: 'background:#E8F5E9', color: 'color:#2E7D32', icon: 'bolt', deco: 'rocket_launch' },
        };
        const DEFAULT_STYLE = { bg: 'background:#F3F4F6', color: 'color:#6B7280', icon: 'label', deco: 'article' };

        const listEl = document.getElementById('todayList');
        const ctaArea = document.getElementById('ctaArea');
        const completeBtn = document.getElementById('completeBtn');
        const ctaText = document.getElementById('ctaText');
        const ctaIcon = document.getElementById('ctaIcon');

        const picks = getTodayPicks(3);

        if (picks.length === 0) {
            listEl.innerHTML = `
                <div class="text-center py-16 opacity-60">
                    <span class="material-symbols-outlined text-6xl block mb-4">inbox</span>
                    <p class="text-lg">아직 분석된 콘텐츠가 없어요</p>
                    <p class="text-sm mt-1 opacity-70">먼저 콘텐츠를 공유해보세요!</p>
                </div>`;
        } else {
            for (const item of picks) {
                const style = INTENT_STYLES[item.intent] || DEFAULT_STYLE;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-black/5 relative overflow-hidden group cursor-pointer hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)] transition-shadow';

                let html = '';

                // Thumbnail
                if (item.thumbnail) {
                    html += `<img class="w-full h-44 object-cover" src="${escapeHtml(item.thumbnail)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
                }

                html += '<div class="p-6 flex flex-col gap-4">';
                html += '<div class="flex justify-between items-start">';
                html += `<span class="px-3 py-1 rounded-full text-xs font-semibold tracking-wide" style="${style.bg};${style.color}">${escapeHtml(item.intent || '기타')}</span>`;
                html += `<span class="material-symbols-outlined text-[#121a31]/20 group-hover:text-[#121a31]/40 transition-colors">${style.icon}</span>`;
                html += '</div>';

                html += '<div>';
                html += `<h3 class="text-xl font-bold leading-tight">${escapeHtml(item.title || '(제목 없음)')}</h3>`;
                html += `<p class="text-[#121a31]/60 mt-2 text-base leading-relaxed line-clamp-2">${escapeHtml(item.summary || '')}</p>`;
                html += '</div>';

                html += `<div class="absolute -right-4 -bottom-4 opacity-[0.04] scale-150 pointer-events-none">`;
                html += `<span class="material-symbols-outlined text-[120px]">${style.deco}</span>`;
                html += '</div>';
                html += '</div>';

                card.innerHTML = html;
                card.addEventListener('click', () => { location.href = `/detail?id=${item.id}`; });
                listEl.appendChild(card);
            }

            ctaArea.style.display = '';

            completeBtn.addEventListener('click', () => {
                for (const item of picks) {
                    incrementViewCount(item.id);
                }
                completeBtn.disabled = true;
                completeBtn.classList.remove('bg-[#121a31]');
                completeBtn.classList.add('bg-[#121a31]/40', 'cursor-not-allowed');
                ctaText.textContent = '잘 하셨어요! 내일 또 만나요';
                ctaIcon.textContent = 'celebration';
            });
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            deferredPrompt = null;
            document.getElementById('installBtn').classList.add('hidden');
        });

    </script>
</body>
</html>
