<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow - 수집함</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#F9F8F6">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { "primary": "#121a31" },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .line-clamp-2 {
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        @keyframes shimmer {
            to { background-position: -200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="bg-[#F9F8F6] text-[#121a31] min-h-screen">

    <!-- Sticky Top Nav -->
    <nav class="sticky top-0 z-50 bg-[#F9F8F6]/80 backdrop-blur-md px-6 py-4 flex items-center justify-between border-b border-black/5">
        <h2 class="text-lg font-semibold tracking-tight">수집함</h2>
        <div class="flex items-center gap-2">
            <span class="text-sm text-[#121a31]/40 font-medium" id="itemCount"></span>
        </div>
    </nav>

    <!-- Header -->
    <header class="max-w-5xl mx-auto px-6 pt-8 pb-6">
        <h1 class="text-3xl font-bold tracking-tight mb-2">최근 저장한 10개</h1>
        <p class="text-[#121a31]/60 text-base" id="aiMsg"></p>
    </header>

    <!-- URL Input -->
    <div class="max-w-5xl mx-auto px-6 mb-6">
        <div class="flex gap-3">
            <input type="url" id="urlInput" placeholder="URL 직접 추가..."
                class="flex-1 px-4 py-3 rounded-2xl border border-black/10 bg-white text-sm outline-none focus:border-[#121a31]/30 focus:ring-2 focus:ring-[#121a31]/5 transition-all placeholder:text-[#121a31]/30"
                autocomplete="off">
            <button id="addBtn"
                class="px-5 py-3 rounded-2xl bg-[#121a31] text-white text-sm font-semibold hover:opacity-90 active:scale-95 transition-all">
                추가
            </button>
        </div>
    </div>

    <!-- Card List -->
    <main class="max-w-5xl mx-auto px-6 pb-28">
        <div id="cardList" class="space-y-4">
            <div class="text-center py-16 opacity-60" id="emptyState">
                <span class="material-symbols-outlined text-6xl block mb-4">inbox</span>
                <p class="text-lg">아직 공유된 콘텐츠가 없습니다</p>
                <p class="text-sm mt-1 opacity-70">다른 앱에서 공유하기를 눌러보세요!</p>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-sm bg-[#121a31]/95 backdrop-blur-xl rounded-full shadow-2xl z-50 px-2 py-2">
        <div class="flex items-center justify-around">
            <a href="/" class="flex flex-col items-center justify-center p-3 rounded-full text-white/40 hover:text-white/70 transition-colors">
                <span class="material-symbols-outlined">home</span>
            </a>
            <a href="/home" class="flex flex-col items-center justify-center p-3 rounded-full text-white bg-white/10">
                <span class="material-symbols-outlined">grid_view</span>
            </a>
            <a href="/report" class="flex flex-col items-center justify-center p-3 rounded-full text-white/40 hover:text-white/70 transition-colors">
                <span class="material-symbols-outlined">analytics</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { getItems, getWeeklyItems, addItem, deleteItem, updateItem, timeAgo, escapeHtml, migrateItems } from '/js/storage.js';
        import { collectAndUpdate } from '/js/collect.js';

        migrateItems();

        const list = document.getElementById('cardList');
        const empty = document.getElementById('emptyState');
        const countEl = document.getElementById('itemCount');
        const aiMsg = document.getElementById('aiMsg');
        const urlInput = document.getElementById('urlInput');
        const addBtn = document.getElementById('addBtn');

        const INTENT_STYLES = {
            '영감': { bg: 'background:#FFF3E0', color: 'color:#E65100' },
            '배움': { bg: 'background:#E3F2FD', color: 'color:#1565C0' },
            '실행': { bg: 'background:#E8F5E9', color: 'color:#2E7D32' },
        };

        const SOURCE_ICONS = {
            instagram: 'IG', youtube: 'YT', twitter: 'X', tiktok: 'TT', web: 'Web'
        };

        function handleAdd() {
            const raw = urlInput.value.trim();
            if (!raw) return;
            try { new URL(raw); } catch { urlInput.value = ''; return; }
            addItem({ url: raw });
            urlInput.value = '';
            render();
        }
        addBtn.addEventListener('click', handleAdd);
        urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAdd(); });

        function render() {
            list.querySelectorAll('[data-card]').forEach((c) => c.remove());
            const items = getItems();
            const weeklyCount = getWeeklyItems().length;

            if (items.length === 0) {
                empty.classList.remove('hidden');
                countEl.textContent = '';
                aiMsg.textContent = '';
                return;
            }
            empty.classList.add('hidden');
            countEl.textContent = `${weeklyCount}개 이번 주`;

            const resolvedCount = items.filter(i => i.resolved).length;
            if (resolvedCount > 0) {
                aiMsg.textContent = `AI가 자동으로 정리했어요 (${resolvedCount}개 분석 완료)`;
            }

            for (const item of items.slice(0, 10)) {
                list.appendChild(buildCard(item));
            }
        }

        function buildCard(item) {
            const card = document.createElement('div');
            card.setAttribute('data-card', '');
            card.dataset.id = item.id;
            card.className = 'bg-white rounded-3xl border border-black/5 shadow-[0_4px_20px_rgb(0,0,0,0.03)] overflow-hidden cursor-pointer hover:shadow-[0_4px_20px_rgb(0,0,0,0.07)] transition-shadow';

            const needsResolve = item.url && !item.resolved;
            let html = '';

            // Thumbnail
            if (item.thumbnail) {
                html += `<img class="w-full max-h-48 object-cover" src="${escapeHtml(item.thumbnail)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
            } else if (needsResolve) {
                html += '<div class="w-full h-36 skeleton" data-slot="image"></div>';
            }

            html += '<div class="p-5">';

            // Intent badge
            if (item.resolved && item.intent) {
                const style = INTENT_STYLES[item.intent] || {};
                html += `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold tracking-wide mb-3" style="${style.bg || 'background:#F3F4F6'};${style.color || 'color:#6B7280'}">${escapeHtml(item.intent)}</span>`;
            } else if (needsResolve) {
                html += '<div class="skeleton h-6 w-16 rounded-full mb-3" data-slot="badges"></div>';
            }

            // Header: title + delete
            html += '<div class="flex justify-between items-start gap-2">';
            html += `<h3 class="text-lg font-bold leading-tight flex-1 line-clamp-2">${escapeHtml(item.title) || '<span class="opacity-40">(제목 없음)</span>'}</h3>`;
            html += `<button class="delete-btn flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-[#121a31]/30 hover:text-red-500 hover:bg-red-50 transition-colors" data-id="${item.id}">`;
            html += '<span class="material-symbols-outlined text-lg">close</span>';
            html += '</button>';
            html += '</div>';

            // Summary
            if (item.summary) {
                html += `<p class="text-[#121a31]/60 text-sm leading-relaxed mt-2 line-clamp-2">${escapeHtml(item.summary)}</p>`;
            } else if (needsResolve) {
                html += '<div class="skeleton h-4 w-3/4 rounded mt-2" data-slot="summary"></div>';
            }

            // Category + tags
            if (item.resolved && (item.category || (item.tags && item.tags.length))) {
                html += '<div class="flex flex-wrap gap-2 mt-3">';
                if (item.category) {
                    html += `<span class="text-xs font-medium text-[#121a31]/50 bg-[#121a31]/5 px-2.5 py-0.5 rounded-full">${escapeHtml(item.category)}</span>`;
                }
                if (item.tags) {
                    for (const tag of item.tags.slice(0, 3)) {
                        html += `<span class="text-xs text-[#121a31]/40 bg-[#121a31]/[0.03] px-2 py-0.5 rounded-full">#${escapeHtml(tag)}</span>`;
                    }
                }
                html += '</div>';
            }

            // Meta: time + source
            html += '<div class="flex justify-between items-center mt-4 pt-3 border-t border-black/5">';
            html += `<span class="text-xs text-[#121a31]/40 font-medium">${timeAgo(item.createdAt)}</span>`;
            if (item.source) {
                html += `<span class="text-xs text-[#121a31]/40 bg-[#121a31]/5 px-2 py-0.5 rounded-full">${SOURCE_ICONS[item.source] || item.source}</span>`;
            }
            html += '</div>';

            html += '</div>'; // p-5
            card.innerHTML = html;

            // Navigate to detail
            card.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) return;
                location.href = `/detail?id=${item.id}`;
            });

            // Resolve if needed
            if (needsResolve) {
                collectAndUpdate(item.id, item.url).then((result) => {
                    if (!result) {
                        card.querySelectorAll('.skeleton').forEach((s) => s.remove());
                        return;
                    }

                    const titleEl = card.querySelector('h3');
                    if (result.title && titleEl) titleEl.textContent = result.title;

                    const summarySlot = card.querySelector('[data-slot="summary"]');
                    if (result.summary) {
                        if (summarySlot) {
                            summarySlot.className = 'text-[#121a31]/60 text-sm leading-relaxed mt-2 line-clamp-2';
                            summarySlot.removeAttribute('data-slot');
                            summarySlot.textContent = result.summary;
                        }
                    } else if (summarySlot) {
                        summarySlot.remove();
                    }

                    const imageSlot = card.querySelector('[data-slot="image"]');
                    if (imageSlot) imageSlot.remove();
                    if (result.thumbnail) {
                        const img = document.createElement('img');
                        img.className = 'w-full max-h-48 object-cover';
                        img.src = result.thumbnail;
                        img.loading = 'lazy';
                        img.onerror = () => img.style.display = 'none';
                        card.insertBefore(img, card.firstChild);
                    }

                    const badgesSlot = card.querySelector('[data-slot="badges"]');
                    if (badgesSlot && result.intent) {
                        const style = INTENT_STYLES[result.intent] || {};
                        badgesSlot.className = 'inline-block px-3 py-1 rounded-full text-xs font-semibold tracking-wide mb-3';
                        badgesSlot.style.cssText = `${style.bg || 'background:#F3F4F6'};${style.color || 'color:#6B7280'}`;
                        badgesSlot.removeAttribute('data-slot');
                        badgesSlot.textContent = result.intent;
                    } else if (badgesSlot) {
                        badgesSlot.remove();
                    }

                    const sourceEl = card.querySelector('.card-meta .card-source');
                    if (result.source) {
                        const metaRow = card.querySelector('.border-t');
                        if (metaRow && !metaRow.querySelector('.source-badge')) {
                            const badge = document.createElement('span');
                            badge.className = 'source-badge text-xs text-[#121a31]/40 bg-[#121a31]/5 px-2 py-0.5 rounded-full';
                            badge.textContent = SOURCE_ICONS[result.source] || result.source;
                            metaRow.appendChild(badge);
                        }
                    }

                    const items = getItems();
                    const rc = items.filter(i => i.resolved).length;
                    aiMsg.textContent = `AI가 자동으로 정리했어요 (${rc}개 분석 완료)`;
                });
            }

            return card;
        }

        // Delete
        list.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;
            e.stopPropagation();
            const id = btn.dataset.id;
            if (id) { deleteItem(id); render(); }
        });

        // Update times
        setInterval(() => {
            const items = getItems();
            document.querySelectorAll('[data-card]').forEach((card) => {
                const id = card.dataset.id;
                const item = items.find((i) => i.id === id);
                const timeEl = card.querySelector('.border-t span:first-child');
                if (item && timeEl) timeEl.textContent = timeAgo(item.createdAt);
            });
        }, 60000);

        render();
    </script>
</body>
</html>
