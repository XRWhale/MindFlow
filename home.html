<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlow - 보관함</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem 6rem;
        }

        /* Top bar */
        .top-bar {
            width: 100%; max-width: 480px;
            margin-bottom: 1rem;
        }
        .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
        .top-bar .count {
            font-size: 0.88rem; opacity: 0.7; margin-top: 0.3rem;
        }
        .top-bar .ai-msg {
            font-size: 0.8rem; opacity: 0.5; margin-top: 0.15rem;
        }

        /* URL input */
        .add-bar {
            width: 100%; max-width: 480px;
            display: flex; gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .add-bar input {
            flex: 1; padding: 0.7rem 1rem;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.1); color: #fff;
            font-size: 0.9rem; outline: none;
        }
        .add-bar input::placeholder { color: rgba(255,255,255,0.4); }
        .add-bar input:focus { border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); }
        .add-bar button {
            padding: 0.7rem 1rem; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2); color: #fff;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            white-space: nowrap; transition: background 0.15s;
        }
        .add-bar button:hover { background: rgba(255,255,255,0.3); }
        .add-bar button:active { transform: scale(0.97); }

        /* Card list */
        #cardList { width: 100%; max-width: 480px; }

        .card {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            overflow: hidden;
            width: 100%;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255,255,255,0.15);
            animation: slideUp 0.3s ease-out;
            cursor: pointer;
            transition: background 0.15s;
        }
        .card:hover { background: rgba(255,255,255,0.18); }
        .card-hero-image {
            width: 100%; max-height: 200px; object-fit: cover;
            display: block;
        }
        .card-body { padding: 0.9rem 1rem; }
        .card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .card-title {
            font-size: 0.95rem; font-weight: 600;
            flex: 1; padding-right: 0.5rem;
            line-height: 1.4;
        }
        .card-summary {
            font-size: 0.84rem; opacity: 0.8; margin-top: 0.35rem;
            line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }

        /* Badges row */
        .card-badges {
            display: flex; flex-wrap: wrap; gap: 0.35rem;
            margin-top: 0.5rem; align-items: center;
        }
        .category-badge {
            font-size: 0.7rem; font-weight: 600;
            background: rgba(255,215,0,0.2); color: #ffd700;
            padding: 0.12rem 0.5rem; border-radius: 20px;
        }
        .tag-chip {
            font-size: 0.68rem;
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);
            padding: 0.1rem 0.4rem; border-radius: 12px;
        }
        .intent-badge {
            font-size: 0.7rem; font-weight: 600;
            padding: 0.12rem 0.5rem; border-radius: 20px;
        }
        .intent-badge[data-intent="배움"] { background: rgba(100,200,255,0.2); color: #64c8ff; }
        .intent-badge[data-intent="실행"] { background: rgba(255,150,100,0.2); color: #ff9664; }
        .intent-badge[data-intent="영감"] { background: rgba(200,100,255,0.2); color: #c864ff; }

        /* Meta row */
        .card-meta {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 0.5rem; padding-top: 0.4rem;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .card-time { font-size: 0.75rem; opacity: 0.4; }
        .card-source {
            font-size: 0.7rem; opacity: 0.5;
            background: rgba(255,255,255,0.1); padding: 0.12rem 0.45rem;
            border-radius: 20px;
        }
        .delete-btn {
            background: none; border: none; color: rgba(255,255,255,0.4);
            font-size: 1.1rem; cursor: pointer; padding: 0.2rem 0.4rem;
            border-radius: 8px; transition: all 0.15s;
        }
        .delete-btn:hover { background: rgba(255,255,255,0.1); color: #ff6b6b; }
        .delete-btn:active { transform: scale(0.9); }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.08) 25%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.08) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .skeleton-hero { width: 100%; height: 140px; }
        .skeleton-text { height: 14px; width: 70%; margin-top: 0.4rem; border-radius: 8px; }
        .skeleton-badge { height: 20px; width: 50px; border-radius: 20px; display: inline-block; }
        @keyframes shimmer { to { background-position: -200% 0; } }

        .empty-state { text-align: center; padding: 3rem 1rem; opacity: 0.7; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
        .hidden { display: none; }

        /* Bottom nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30,20,60,0.85); backdrop-filter: blur(12px);
            display: flex; justify-content: center; gap: 2rem;
            padding: 0.75rem 1rem; padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .bottom-nav a {
            color: #fff; text-decoration: none; font-size: 0.82rem;
            opacity: 0.6; text-align: center; display: flex;
            flex-direction: column; align-items: center; gap: 0.2rem;
        }
        .bottom-nav a.active { opacity: 1; }
        .bottom-nav a .icon { font-size: 1.3rem; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>&#128451; 보관함</h1>
        <div class="count" id="itemCount"></div>
        <div class="ai-msg" id="aiMsg"></div>
    </div>

    <div class="add-bar">
        <input type="url" id="urlInput" placeholder="URL 직접 추가..." autocomplete="off">
        <button id="addBtn">추가</button>
    </div>

    <div id="cardList">
        <div class="empty-state" id="emptyState">
            <div class="icon">&#128233;</div>
            <p>아직 공유된 콘텐츠가 없습니다.<br>다른 앱에서 공유하기를 눌러보세요!</p>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/"><span class="icon">&#127968;</span>홈</a>
        <a href="/home" class="active"><span class="icon">&#128451;</span>보관함</a>
        <a href="/report"><span class="icon">&#129302;</span>리포트</a>
    </nav>

    <script type="module">
        import { getItems, getWeeklyItems, addItem, deleteItem, updateItem, timeAgo, escapeHtml, migrateItems } from '/js/storage.js';
        import { collectAndUpdate } from '/js/collect.js';

        migrateItems();

        const list = document.getElementById('cardList');
        const empty = document.getElementById('emptyState');
        const countEl = document.getElementById('itemCount');
        const aiMsg = document.getElementById('aiMsg');
        const urlInput = document.getElementById('urlInput');
        const addBtn = document.getElementById('addBtn');

        const SOURCE_ICONS = {
            instagram: 'IG', youtube: 'YT', twitter: 'X', tiktok: 'TT', web: 'Web'
        };

        function handleAdd() {
            const raw = urlInput.value.trim();
            if (!raw) return;
            try { new URL(raw); } catch { urlInput.value = ''; return; }
            addItem({ url: raw });
            urlInput.value = '';
            render();
        }
        addBtn.addEventListener('click', handleAdd);
        urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAdd(); });

        function render() {
            list.querySelectorAll('.card').forEach((c) => c.remove());
            const items = getItems();
            const weeklyCount = getWeeklyItems().length;

            if (items.length === 0) {
                empty.classList.remove('hidden');
                countEl.textContent = '';
                aiMsg.textContent = '';
                return;
            }
            empty.classList.add('hidden');
            countEl.textContent = `이번 주 저장한 콘텐츠: ${weeklyCount}개`;

            const resolvedCount = items.filter(i => i.resolved).length;
            if (resolvedCount > 0) {
                aiMsg.textContent = `AI가 자동으로 정리했어요 (${resolvedCount}개 분석 완료)`;
            }

            for (const item of items) {
                list.appendChild(buildCard(item));
            }
        }

        function buildCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = item.id;

            const needsResolve = item.url && !item.resolved;
            let html = '';

            // Thumbnail
            if (item.thumbnail) {
                html += `<img class="card-hero-image" src="${escapeHtml(item.thumbnail)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
            } else if (needsResolve) {
                html += `<div class="skeleton skeleton-hero" data-slot="image"></div>`;
            }

            html += '<div class="card-body">';

            // Header: title + delete
            html += '<div class="card-header">';
            html += `<div class="card-title">${escapeHtml(item.title) || '<span style="opacity:0.5">(제목 없음)</span>'}</div>`;
            html += `<button class="delete-btn" data-id="${item.id}" title="삭제">&#128465;</button>`;
            html += '</div>';

            // Summary
            if (item.summary) {
                html += `<div class="card-summary">${escapeHtml(item.summary)}</div>`;
            } else if (needsResolve) {
                html += `<div class="skeleton skeleton-text" data-slot="summary"></div>`;
            }

            // Badges: category + tags + intent
            if (item.resolved && (item.category || item.tags?.length || item.intent)) {
                html += '<div class="card-badges">';
                if (item.category) {
                    html += `<span class="category-badge">${escapeHtml(item.category)}</span>`;
                }
                if (item.tags && item.tags.length > 0) {
                    for (const tag of item.tags) {
                        html += `<span class="tag-chip">#${escapeHtml(tag)}</span>`;
                    }
                }
                if (item.intent) {
                    html += `<span class="intent-badge" data-intent="${escapeHtml(item.intent)}">${escapeHtml(item.intent)}</span>`;
                }
                html += '</div>';
            } else if (needsResolve) {
                html += '<div class="card-badges"><span class="skeleton skeleton-badge" data-slot="badges"></span></div>';
            }

            // Meta: time + source
            html += '<div class="card-meta">';
            html += `<span class="card-time">${timeAgo(item.createdAt)}</span>`;
            if (item.source) {
                html += `<span class="card-source">${SOURCE_ICONS[item.source] || item.source}</span>`;
            }
            html += '</div>';

            html += '</div>'; // card-body
            card.innerHTML = html;

            // Navigate to detail on card click (not delete button)
            card.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) return;
                location.href = `/detail?id=${item.id}`;
            });

            // Resolve if needed
            if (needsResolve) {
                collectAndUpdate(item.id, item.url).then((result) => {
                    if (!result) {
                        card.querySelectorAll('.skeleton').forEach((s) => s.remove());
                        return;
                    }

                    // Update title
                    const titleEl = card.querySelector('.card-title');
                    if (result.title && titleEl) titleEl.textContent = result.title;

                    // Update summary
                    const summarySlot = card.querySelector('[data-slot="summary"]');
                    if (result.summary) {
                        if (summarySlot) {
                            summarySlot.className = 'card-summary';
                            summarySlot.textContent = result.summary;
                        }
                    } else if (summarySlot) {
                        summarySlot.remove();
                    }

                    // Update image
                    const imageSlot = card.querySelector('[data-slot="image"]');
                    if (imageSlot) imageSlot.remove();
                    if (result.thumbnail) {
                        const img = document.createElement('img');
                        img.className = 'card-hero-image';
                        img.src = result.thumbnail;
                        img.loading = 'lazy';
                        img.onerror = () => img.style.display = 'none';
                        card.insertBefore(img, card.firstChild);
                    }

                    // Update badges
                    const badgesSlot = card.querySelector('[data-slot="badges"]');
                    if (badgesSlot) {
                        const badgesContainer = badgesSlot.parentElement;
                        badgesSlot.remove();
                        if (result.category) {
                            const cat = document.createElement('span');
                            cat.className = 'category-badge';
                            cat.textContent = result.category;
                            badgesContainer.appendChild(cat);
                        }
                        if (result.tags) {
                            for (const tag of result.tags) {
                                const t = document.createElement('span');
                                t.className = 'tag-chip';
                                t.textContent = '#' + tag;
                                badgesContainer.appendChild(t);
                            }
                        }
                        if (result.intent) {
                            const i = document.createElement('span');
                            i.className = 'intent-badge';
                            i.dataset.intent = result.intent;
                            i.textContent = result.intent;
                            badgesContainer.appendChild(i);
                        }
                    }

                    // Update source
                    const sourceEl = card.querySelector('.card-source');
                    if (result.source) {
                        if (sourceEl) {
                            sourceEl.textContent = SOURCE_ICONS[result.source] || result.source;
                        } else {
                            const badge = document.createElement('span');
                            badge.className = 'card-source';
                            badge.textContent = SOURCE_ICONS[result.source] || result.source;
                            card.querySelector('.card-meta')?.appendChild(badge);
                        }
                    }

                    // Update AI message count
                    const items = getItems();
                    const rc = items.filter(i => i.resolved).length;
                    aiMsg.textContent = `AI가 자동으로 정리했어요 (${rc}개 분석 완료)`;
                });
            }

            return card;
        }

        // Delete (event delegation)
        list.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-btn');
            if (!btn) return;
            e.stopPropagation();
            const id = btn.dataset.id;
            if (id) { deleteItem(id); render(); }
        });

        // Update times every minute
        setInterval(() => {
            const items = getItems();
            document.querySelectorAll('.card').forEach((card) => {
                const id = card.dataset.id;
                const item = items.find((i) => i.id === id);
                const timeEl = card.querySelector('.card-time');
                if (item && timeEl) timeEl.textContent = timeAgo(item.createdAt);
            });
        }, 60000);

        render();
    </script>
</body>
</html>
